{% extends 'base.html' %}
{% block title %}PDF Form Designer{% endblock %}

{% block extra_css %}
<style>
    body {
        margin: 0;
        background-color: #f4f6f9; /* SaaS light grey bg */
        overflow-x: hidden;
    }

    #designer-wrapper {
        display: flex;
        justify-content: center;
        padding: 40px;
        min-height: calc(100vh - 56px);
        background-color: #e9ecef;
    }

    #page-canvas {
        /* A4 Size in Points: 595.27 x 841.89 */
        width: 595.27px;
        height: 841.89px;
        background-color: white;
        position: relative;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        /* Professional Grid */
        background-image:
            linear-gradient(#e5e5e5 1px, transparent 1px),
            linear-gradient(90deg, #e5e5e5 1px, transparent 1px);
        background-size: 20px 20px;
        border: 1px solid #dcdcdc;
        overflow: hidden;
    }

    .draggable-element {
        position: absolute;
        box-sizing: border-box;
        border: 1px solid #ced4da; /* Subtle gray border */
        background-color: #ffffff;
        cursor: grab;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        color: #495057;
        user-select: none;
        touch-action: none;
        z-index: 10;
        overflow: hidden;
        padding: 4px;
        transition: box-shadow 0.2s ease, border-color 0.2s ease;
    }

    .draggable-element:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-color: #adb5bd;
        z-index: 100;
    }

    .draggable-element:active {
        cursor: grabbing;
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    /* Mock Content Styles */
    .mock-content {
        width: 100%;
        height: 100%;
        pointer-events: none; /* Let drag events pass through */
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
    }

    .mock-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 9px;
    }
    .mock-table th { background: #f8f9fa; border-bottom: 1px solid #ddd; padding: 2px; }
    .mock-table td { border-bottom: 1px solid #eee; padding: 2px; }

    .mock-sig-box {
        border: 1px dashed #ccc;
        background: #fafafa;
        width: 30%;
        height: 80%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 9px;
        color: #999;
    }

    #controls-panel {
        position: fixed;
        top: 80px;
        right: 20px;
        width: 240px;
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.08);
        z-index: 1000;
        border: 1px solid #e9ecef;
    }

    #controls-panel h5 {
        font-weight: 600;
        color: #343a40;
        margin-bottom: 16px;
    }
</style>
<!-- Interact.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
{% endblock %}

{% block content %}
<div id="controls-panel">
    <h5>Form Designer</h5>
    <p class="small text-muted mb-4">
        Drag elements to position.<br>
        Resize via edges.<br>
        Changes apply to new PDFs.
    </p>

    <div class="d-grid gap-2">
        <button id="save-layout-btn" class="btn btn-primary">
            <i class="bi bi-save"></i> Save Layout
        </button>
        <a href="{% url 'preview_template_layout' %}" target="_blank" class="btn btn-outline-info">
            <i class="bi bi-eye"></i> Preview Sample PDF
        </a>
    </div>

    <div id="save-status" class="mt-3 text-center fw-bold small"></div>
    <hr class="my-3">
    <a href="{% url 'dashboard' %}" class="btn btn-link btn-sm w-100 text-decoration-none text-muted">Back to Dashboard</a>
</div>

<div id="designer-wrapper">
    <div id="page-canvas">
        {% for element in elements %}
        <div class="draggable-element"
             id="el-{{ element.element_name }}"
             data-name="{{ element.element_name }}"
             style="transform: translate({{ element.pos_x }}px, {{ element.pos_y }}px); width: {{ element.width }}px; height: {{ element.height }}px;"
             data-x="{{ element.pos_x }}"
             data-y="{{ element.pos_y }}">
             <div class="mock-content" id="mock-{{ element.element_name }}">
                <!-- Content injected via JS -->
                {{ element.get_element_name_display }}
             </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // --- Mock Data Injection ---
    function injectMockData() {
        const elements = document.querySelectorAll('.draggable-element');
        elements.forEach(el => {
            const name = el.getAttribute('data-name');
            const container = el.querySelector('.mock-content');
            if(!container) return;

            let html = '';

            switch(name) {
                case 'header_logo':
                    html = '<div style="background:#eee; width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:#777; font-weight:bold;">LOGO</div>';
                    break;
                case 'company_info':
                    html = '<div style="text-align:left; width:100%;"><strong>Acme Corp Inc.</strong><br>123 Business Rd<br>Tech City, TC 90210</div>';
                    break;
                case 'jobcard_meta':
                    html = '<div style="text-align:left; width:100%;"><strong>JC-12345</strong><br>Date: 2023-10-27<br>Status: Approved</div>';
                    break;
                case 'client_details':
                    html = '<div style="text-align:left; width:100%;"><strong>Client:</strong> Client Co.<br>456 Client St</div>';
                    break;
                case 'start_stop_times':
                    html = '<div style="display:flex; justify-content:space-between; width:100%;"><span>Start: 09:00</span><span>Stop: 11:30</span></div>';
                    break;
                case 'items_table':
                    html = `
                        <table class="mock-table">
                            <thead><tr><th>Desc</th><th>Part</th><th>Qty</th></tr></thead>
                            <tbody>
                                <tr><td>Fix Network</td><td>Cable</td><td>10m</td></tr>
                                <tr><td>Replace SW</td><td>Switch</td><td>1</td></tr>
                                <tr><td>Config</td><td>-</td><td>1</td></tr>
                            </tbody>
                        </table>
                    `;
                    break;
                case 'manager_notes':
                    html = '<div style="text-align:left; width:100%; font-style:italic; border-top:1px solid #eee; padding-top:2px;"><strong>Manager Notes:</strong><br>Approved. Good job.</div>';
                    break;
                case 'admin_notes':
                    html = '<div style="text-align:left; width:100%; font-style:italic; border-top:1px solid #eee; padding-top:2px;"><strong>Admin Notes:</strong><br>Invoiced #999</div>';
                    break;
                case 'signatures':
                    html = `
                        <div style="display:flex; justify-content:space-between; width:100%; height:100%;">
                            <div class="mock-sig-box">Tech</div>
                            <div class="mock-sig-box">Client</div>
                            <div class="mock-sig-box">Manager</div>
                        </div>
                    `;
                    break;
                default:
                    html = `<strong>${el.innerText.trim()}</strong>`;
            }
            container.innerHTML = html;
        });
    }

    // Run injection
    injectMockData();

    // --- Interact.js Logic ---
    interact('.draggable-element')
    .draggable({
        inertia: true,
        modifiers: [
            interact.modifiers.restrictRect({
                restriction: 'parent',
                endOnly: true
            })
        ],
        autoScroll: true,
        listeners: { move: dragMoveListener }
    })
    .resizable({
        edges: { left: true, right: true, bottom: true, top: true },
        listeners: {
            move: function (event) {
                var target = event.target;
                var x = (parseFloat(target.getAttribute('data-x')) || 0);
                var y = (parseFloat(target.getAttribute('data-y')) || 0);

                target.style.width = event.rect.width + 'px';
                target.style.height = event.rect.height + 'px';

                x += event.deltaRect.left;
                y += event.deltaRect.top;

                target.style.transform = 'translate(' + x + 'px, ' + y + 'px)';
                target.setAttribute('data-x', x);
                target.setAttribute('data-y', y);
            }
        },
        modifiers: [
            interact.modifiers.restrictEdges({ outer: 'parent' }),
            interact.modifiers.restrictSize({ min: { width: 50, height: 30 } })
        ],
        inertia: true
    });

    function dragMoveListener (event) {
        var target = event.target;
        var x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
        var y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

        target.style.transform = 'translate(' + x + 'px, ' + y + 'px)';
        target.setAttribute('data-x', x);
        target.setAttribute('data-y', y);
    }

    // --- Save Logic ---
    const saveBtn = document.getElementById('save-layout-btn');
    const statusDiv = document.getElementById('save-status');

    saveBtn.addEventListener('click', function() {
        const elements = document.querySelectorAll('.draggable-element');
        const payload = [];

        elements.forEach(el => {
            const x = parseFloat(el.getAttribute('data-x'));
            const y = parseFloat(el.getAttribute('data-y'));
            const width = parseFloat(el.style.width);
            const height = parseFloat(el.style.height);

            payload.push({
                name: el.getAttribute('data-name'),
                x: x, y: y, width: width, height: height
            });
        });

        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
        statusDiv.innerText = "";

        fetch("{% url 'save_template_layout' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ elements: payload })
        })
        .then(response => response.json())
        .then(data => {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="bi bi-save"></i> Save Layout';

            if (data.status === 'success') {
                statusDiv.innerText = "Saved Successfully!";
                statusDiv.className = "mt-3 text-center fw-bold text-success";
                setTimeout(() => statusDiv.innerText = "", 3000);
            } else {
                statusDiv.innerText = "Error: " + data.message;
                statusDiv.className = "mt-3 text-center fw-bold text-danger";
            }
        })
        .catch(error => {
            console.error('Error:', error);
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="bi bi-save"></i> Save Layout';
            statusDiv.innerText = "Network Error";
            statusDiv.className = "mt-3 text-center fw-bold text-danger";
        });
    });
</script>
{% endblock %}
