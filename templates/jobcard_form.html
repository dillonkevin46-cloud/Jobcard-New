{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Jobcard - {{ user.username }}{% endblock %}

{% block extra_css %}
<style>
    .jobcard-container {
        background-color: #ffffff;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        border: 1px solid #e9ecef;
    }
    .jobcard-header {
        background-color: #fcf4bd; /* The requested subtle yellow, used as a top banner */
        margin: -30px -30px 30px -30px;
        padding: 20px 30px;
        border-radius: 12px 12px 0 0;
        border-bottom: 2px solid #f2e27c;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .signature-pad-wrapper canvas {
        cursor: crosshair;
    }
    .formset-row {
        background-color: #fff;
        transition: background-color 0.2s;
    }
    .formset-row:hover {
        background-color: #f8f9fa;
    }
    .table-input input {
        border: 1px solid transparent;
        background: transparent;
        border-radius: 4px;
        padding: 4px 8px;
        width: 100%;
        transition: border 0.2s, background 0.2s;
    }
    .table-input input:focus, .table-input input:hover {
        border: 1px solid #ced4da;
        background: #fff;
        outline: none;
    }
    /* Hide crispy labels in table */
    #items-table label { display: none; }
    #items-table .mb-3 { margin-bottom: 0 !important; }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center mb-5">
    <div class="col-xl-10">
        <div class="jobcard-container">
            <div class="jobcard-header">
                <h3 class="mb-0 text-dark fw-bold"><i class="bi bi-card-checklist me-2"></i>Job Card</h3>
                <span class="badge bg-dark rounded-pill px-3 py-2 fs-6 shadow-sm">
                    {% if jobcard.pk %}{{ jobcard.jobcard_number }}{% else %}New Draft{% endif %}
                </span>
            </div>

            <form method="post" id="jobcardForm" enctype="multipart/form-data"
                  {% if jobcard.pk %}data-autosave-url="{% url 'jobcard_autosave' jobcard.pk %}"{% endif %}>
                {% csrf_token %}

                {% crispy form %}

                <div class="d-flex justify-content-between align-items-center mt-5 mb-3">
                    <h5 class="mb-0 fw-bold text-primary"><i class="bi bi-tools me-2"></i>Job Details & Parts Used</h5>
                    <button type="button" class="btn btn-outline-primary btn-sm rounded-pill px-3" id="add-item-btn">
                        <i class="bi bi-plus"></i> Add Row
                    </button>
                </div>

                {{ items.management_form }}

                <div class="table-responsive rounded shadow-sm border border-light mb-4">
                    <table class="table table-borderless align-middle mb-0" id="items-table">
                        <thead class="table-light text-muted small border-bottom">
                            <tr>
                                <th style="width: 40%">Description of Work</th>
                                <th style="width: 30%">Parts / Serial No.</th>
                                <th style="width: 10%">Qty</th>
                                <th style="width: 15%">Person Helped</th>
                                <th style="width: 5%" class="text-center"><i class="bi bi-trash"></i></th>
                            </tr>
                        </thead>
                        <tbody id="formset-body">
                            {% for form in items %}
                                <tr class="formset-row border-bottom">
                                    {{ form.id }}
                                    <td class="table-input">{{ form.description|as_crispy_field }}</td>
                                    <td class="table-input">{{ form.parts_used|as_crispy_field }}</td>
                                    <td class="table-input">{{ form.qty|as_crispy_field }}</td>
                                    <td class="table-input">{{ form.person_helped|as_crispy_field }}</td>
                                    <td class="text-center align-middle">
                                        {% if items.can_delete %}
                                            <div class="form-check d-flex justify-content-center">
                                                {{ form.DELETE }}
                                            </div>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="d-flex align-items-center justify-content-between mt-5 pt-3 border-top">
                    <div id="autosave-status" class="text-muted small fw-medium">
                        <i class="bi bi-cloud-check me-1"></i>Ready
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" name="action" value="draft" class="btn btn-light border px-4 shadow-sm" id="btn-save-draft">
                            Save Draft
                        </button>
                        <button type="submit" name="action" value="submit" class="btn btn-primary px-4 shadow" id="btn-submit-final" onclick="return confirm('Submit and email to client? This locks the jobcard.');">
                            <i class="bi bi-send me-2"></i>Submit & Email
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // --- Time Tracking ---
    function setDateTime(fieldId) {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById(fieldId).value = now.toISOString().slice(0, 16);
        triggerAutosave();
    }

    // --- Signature Pads ---
    function initPad(canvasId, dataFieldId) {
        const canvas = document.getElementById(canvasId);
        if(!canvas) return null;

        function resizeCanvas() {
            const ratio =  Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
        }
        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();

        const pad = new SignaturePad(canvas, {
            penColor: "rgb(0, 0, 128)",
            backgroundColor: "rgba(255, 255, 255, 0)"
        });

        const hiddenInput = document.getElementById(dataFieldId);

        pad.addEventListener("endStroke", () => {
             if (hiddenInput) hiddenInput.value = pad.toDataURL();
             triggerAutosave();
        });

        return pad;
    }

    const techPad = initPad('tech_sig_pad', 'id_tech_signature_data');
    const clientPad = initPad('client_sig_pad', 'id_client_signature_data');

    function clearPad(canvasId) {
        if(canvasId === 'tech_sig_pad' && techPad) {
            techPad.clear();
            document.getElementById('id_tech_signature_data').value = '';
        }
        if(canvasId === 'client_sig_pad' && clientPad) {
            clientPad.clear();
            document.getElementById('id_client_signature_data').value = '';
        }
        triggerAutosave();
    }

    // --- Form Submission ---
    document.getElementById('jobcardForm').addEventListener('submit', function(e) {
        if (techPad && !techPad.isEmpty()) {
            document.getElementById('id_tech_signature_data').value = techPad.toDataURL();
        }
        if (clientPad && !clientPad.isEmpty()) {
            document.getElementById('id_client_signature_data').value = clientPad.toDataURL();
        }
    });

    // --- Dynamic Formset ---
    document.getElementById('add-item-btn').addEventListener('click', function() {
        const formIdx = document.getElementById('id_items-TOTAL_FORMS').value;
        const formTable = document.getElementById('formset-body');
        const emptyRow = formTable.rows[0].cloneNode(true);

        const regex = new RegExp(`items-(\\d+)-`, 'g');
        emptyRow.innerHTML = emptyRow.innerHTML.replace(regex, `items-${formIdx}-`);

        const inputs = emptyRow.querySelectorAll('input');
        inputs.forEach(input => {
            if(input.type !== 'checkbox') input.value = '';
            if(input.type === 'checkbox') input.checked = false;
            if(input.name.endsWith('-id')) input.value = '';
        });

        formTable.appendChild(emptyRow);
        document.getElementById('id_items-TOTAL_FORMS').value = parseInt(formIdx) + 1;
    });

    // --- Auto-Save ---
    const form = document.getElementById('jobcardForm');
    const autosaveUrl = form.getAttribute('data-autosave-url');
    let autosaveTimer;

    function triggerAutosave() {
        if (!autosaveUrl) return;

        clearTimeout(autosaveTimer);
        const statusEl = document.getElementById('autosave-status');
        statusEl.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span>Saving...';
        statusEl.classList.add('text-primary');
        statusEl.classList.remove('text-muted', 'text-success', 'text-danger');

        autosaveTimer = setTimeout(() => {
            // Need to track which submit button was pressed so autosave doesn't trigger full validation.
            // By default FormData won't include button values.
            const formData = new FormData(form);
            if (techPad && !techPad.isEmpty()) formData.set('tech_signature_data', techPad.toDataURL());
            if (clientPad && !clientPad.isEmpty()) formData.set('client_signature_data', clientPad.toDataURL());

            fetch(autosaveUrl, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => {
                if (response.ok) {
                    statusEl.innerHTML = '<i class="bi bi-cloud-check-fill me-1"></i>Saved at ' + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    statusEl.classList.add('text-success');
                    statusEl.classList.remove('text-primary');
                } else {
                    statusEl.innerHTML = '<i class="bi bi-exclamation-circle me-1"></i>Save Error';
                    statusEl.classList.add('text-danger');
                    statusEl.classList.remove('text-primary');
                }
            })
            .catch(error => {
                statusEl.innerHTML = '<i class="bi bi-wifi-off me-1"></i>Offline / Error';
                statusEl.classList.add('text-danger');
                statusEl.classList.remove('text-primary');
            });
        }, 2000);
    }

    if (autosaveUrl) {
        form.addEventListener('input', function(e) {
             if (e.target.type !== 'hidden') triggerAutosave();
        });
    }
</script>
{% endblock %}
